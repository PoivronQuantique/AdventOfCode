namespace AdventOfCode.Dec_2023
{
    public class Jour_21 : Jour_abs
    {
        #region Enumerables
        #endregion

        #region Helpers
        #endregion

        #region Propriétés
        private Graphe Graph { get; set; }
        #endregion

        #region Constructeur
        public Jour_21(bool debug = false):base(debug)
        {
            #region Input Data
            string InputData = "...................................................................................................................................\r\n...##..##......#...###.....###...#..............#.......................#....................#.#.#........#.............#..........\r\n.#..........#...#.#..#....#.#........#.....#..#...........#..................................#.....#.............#..#.#.#.....##...\r\n..#....#...................#..........#....#..........#.#..........................#.............#.#.#..............#.#............\r\n....#...#............#....#.#.#..#.........#..#......#..#....................#..#.#.............##............#.............##.....\r\n..........#............##..#....#.#.............................#.................#....##.##.##....#...##..#.....#.....#.....#.....\r\n......#..#...#.#..............#.#......#.#.......#....#........##..#.......#.#.#.....#......#..#.#..#.......#.........##...........\r\n...#..#..............#....#.#.......#......#....#.....#.............#........................#.......#..#........#..........##.....\r\n...#....#...#..#..#.....#..#....#.#...#.....#...................#.............#...#.....#..#..#..#.........#.....#.......#.........\r\n....#....#.......##..........#............#..#.......................................#.#......#.#...#.....#...#........#...#.......\r\n.....#...###....#....#...#..............#.........................#.##......................##..#..#.#.##.........#...#............\r\n...........#.......#.......#.....#...............#................#.#..##...........##..#.......###.#.#..#...#.#..........#........\r\n..#......###..........#.#.......#..#..#..##....#...................#....#........###..#.#.....#...........#..............#..#....#.\r\n....#.........#.#....#.........#..#.#.....#...#.........#..#........#...................#....#.#....#..#.#.....#....#...##..#.##...\r\n....#..#....#.............#.......#.#...#..............#..........#....#...#........##...#.......#.........#.##............##......\r\n.......#.#...........#....#...................................#....#........#...........#.#.###...#.........#.##.#....#...#.#..##..\r\n....#..#........#..#..#.#..#.........#......#.............#..............#..................#.....#.#.....#..#.........#...#.......\r\n........##...##..#......##...........#.................#.....###..#....#...#..........#.#..............#..#......................#.\r\n.#............#.......##...........#.....................#.........#.........................##.....#..###.....#...#..###........#.\r\n...........##...#............#......#.................#.....#..#...#...#.......#.........#..##.........#....###.....#.#......##..#.\r\n.#....##.......#.......#...#..##..#.#...#............#.#...#......#...........................#.........#........#.........##......\r\n..#...#...##.#.......................##...........#..#........#.#.....##..#.##.#..#.......#..#.....#.####.#.......#......#.........\r\n.....#.##.#...##.#...........#.................#.....#....#.#..#.......#.........................#.#......#.##..#....#.#........#..\r\n.....##.###..#...................#.........................#..#....#..#....................................#..##..#.#...#..#..#.#..\r\n.#......#.#......#.............#.##..#.........##...##..........#.........#..#...#.#...........#.....##.......#.............##.#...\r\n....#..........#.#....#...#.#....................#.###.........#......##...#.........#............#........#....#..#....##.#...##..\r\n.............##.....#...#...#......#.............#............##.....#.......#.#........................#..#..........#...#........\r\n..#......##............#...#.........................##..##..............#..#......#.................##........#...............##..\r\n..#.......#...#......#...................#........#..#...##............##..#.....#..........................#.#..........#.........\r\n...##..#...##..........##....###.........#.......##..................#.......#....................#...........#.#........#.........\r\n......#....#......#.......#...#....................#..#........#..#......#..#.#....##.........................#.#....#.#....#....#.\r\n.....#......................#................#......##......##.#.........#..##.........#...............##.......#.........#........\r\n.#.#......#.#....#..#...#..............#......#..#.#.....#..........##.....#..#........#...#.#.........#..#.....................#..\r\n...#.##.#..#..#...#.#................###....................##.....#.#....#.........#......#..#..........##.#....#......#..#.......\r\n...#.................#.............#................#.................###..............#.................#..#......#.....#......##.\r\n.#.#.....#..#..........#...........#.#............#.##..#......#..##....#.#..###.......##.#.....#.........##...#.#...........#.....\r\n..#...#................#....................#..#..........#...............#.....#..#..####................#...............#........\r\n..........#..........#..............#........#...##...............#.....#...#...#..##.....#...#...........##.#.....##.#......#.....\r\n....#......#.......#...#.......#........#....#.....#..............#....#..##..#......#........#...............#.................#..\r\n.#.............#...............#...............#..#...#..#.#...#..#.......#....................#....#........#..##........#........\r\n.....................................#....###....#...#.....##.#.......#.........#.#.....#........#...........#...........##......#.\r\n.......#.##...#..............#..##..#...#...........#.##..##..#....#..#.........#........#.#.....................#.......#.......#.\r\n..#......##...................#..........#........##.....#..........#...#.#....#.#....#............##..............#...#.#.#.......\r\n...#.#.##.#.#.......................##......#.......#.........#.........#..........#........#.#.....#.#.............#.........#....\r\n.#.#...........#..................#....#......#.#............#....#.#..#...#..#..##.#............................#.#........#.##...\r\n..#...#....#...................#....#..........#.......................#.....##..#...#.#.#.......#...#..#.........#......##........\r\n.......#.................#...#........#....#.................#......................#...#.........##..................#......#.....\r\n..#..#....#..#...............#................#..#.#.....#.#..#.........###.......................#.#..#....#..........#...........\r\n......#...#..#...........#......................#..#............................#.....#........#.....##...#............#...........\r\n...........................##..#....#....#.....#....#....#...#........#.......#.........#.#..........##...#..................#..#..\r\n......#.....................#.....#.......#.#.....#.............#....#...#......#....#..#..........#........#...........#..........\r\n..#...#.............#..............#.#....#....#.....#....#...#.#......#.....#.#...........#.#.........#.#..................#..###.\r\n..#..............#....##......#.##..................#...##.........#..........#.................#..........#...................#...\r\n................#.##...#......##.........#.#...#..####.#.............#...#....#.........#.................................#........\r\n....#..........................#.......#...............#......#.......#...###.##.....#.#.#....#..###....#...#...##...........##....\r\n...#.#...............#..................#.........#...#.#..............#.....#.......#...#.##...#..#.......#.....#...........#.....\r\n.....#.....................#.#.#.....#.#.....#..#..##...#.....#...........#...##........#..#.......#.#...#....#..#............#....\r\n..#..........#....##..#.....###.#...............................#.#.##.#...#....##........#...#.....#....#............#.......#....\r\n.#...........#...#..#.....#..........#............#.......##......#.................#.#...#..##........#...............#...........\r\n.#................#........##.#.#.....#.#.............#.....#..#..##...............#..#................#.......#...#...##.......##.\r\n.#........#.##........##..#.#.##.....#..###..#......##...#......#..........#...............#.....#....#......#.....................\r\n............#.........#..............#.....#..#......................#...#.##.##...###..#..........###........###..................\r\n...........#...##.............#......#.....#.#...#...#.#..#....#..#............#....#..#.....#.#.........#.....#..#.###....#.......\r\n.........#........#.......#..#..##..#........#.#.#...........#....................##..#....#..#.....##.......##...##...............\r\n.......#....##..........##.....#...##....#.........#..#...................#......###.....#........#.....................#.#.#......\r\n.................................................................S.................................................................\r\n.....#...........#...#....#...#..#.........#.......##.#.............................#...#....#......#......#...#.#......#....#.....\r\n........###...#.......................#...........#.....#.#.........#.#......#...#.....#..#...###.....#.#....#..........#..........\r\n...............#.#............#.#......#...#..#.......#..#.#..#....##.#..#....#...............#.##.#..#...#...#..#.................\r\n.............#.##..........#........#.#........###.....#..............#.......#..........##...........#........#...#...............\r\n...........#.#.#........#......###.....#.#......#.#..##..#..#...#...##.#.#...##.......#........#..#.#.##...###...........#.........\r\n..........##..............#......#.............#..#.#....#..#.....#.#...#..........##............#...#.##.....#.#..#...............\r\n.#.#...............#.#............##.......#...#..#....#.....#........#.#..###...#.....#.........#................#..#.............\r\n.............#...#........#....#....#..........##.#....#......#.....#.........#..#........#.......###....#.#....#....##............\r\n...#............#.#......#...#....#..............#.....#..##....#.....#....#.....#...#...#.#..#.........#.#.........#..............\r\n..............#.......#...........#..............#.#.......#..#.#......#...##.......#................#...#.....#...#...............\r\n...##...........................#...#...#.......#............#.#.....#...#....#..#......#..#.##....#.#...#...#.................#.#.\r\n...#....#...........#.........##...#............#...............#...................................##..#......#..#..............#.\r\n...##.#.#.............#....#.##.#........#.....#.#...#.....##...........#.....................#...#..#......#............##.....#..\r\n...#..#...#...............#.#......#....#.#.#......#...................#......#.....##....#....#....##...#......#..............#...\r\n......#..#.........#.................#...#................#.........#..................................................#....#......\r\n.#..........#..........#..................#.#...#....#....#.#.........#..#...#........#......#.............#....................#..\r\n........#............#........#.......##......##....#................#.......#....#.#.....#............#.#.#...............###.....\r\n.##........#..........#...#......##..#.##.#.....##.........................#.....##.#...#......#.#......#..#..........#............\r\n....#....................#...#.......#...#.......#.....#......#...#..#...#......#.#..#...##.##..#.....##...........#..#.###........\r\n.#.....#........#..............#...#...#.........#.#................#.#.............##.#....#..#.....................#.....#..###..\r\n......#...#.#..#.............##.#........#.....................#........#....#...........#....##......................#............\r\n..#.....##...#..#.#.........#.#.......#.#..#......#..........#.##....#..#..................#.........#..#........#....##...........\r\n..#...#.#....#.#...................##......##...........#...#.............#..........#.##..#.#......#..................#..#.#...##.\r\n...##...#........#.#.........#...#.....#.#...##...#...#..#.#.........#.....#..#....#.###...#........#.............#.........#....#.\r\n.........#...#.#...#.#.................#............#........................#.#.....#.........#................#.....#..#......#..\r\n...........#.#..#.............##........#..........#....#...........#....#.....#....#....#.#......##.........#..##....#..##........\r\n.........#..................................#..#...............#...#..#...#...#..#......#.#..#.............#...........#.#..#...##.\r\n.#.#......#..#.......#.##........#......#....#................#...#...##..##....#.....#..........#.........#....#..#.#.........#...\r\n.....#.....#.........#............#....#.....................#....#.##...#......................#................#.#.#...#.........\r\n.....#.............##..#..........#..#..............##..#.................##........###.....#.#.........#.#.#...............#......\r\n.#.#.#...#.#..............#...............#...............#..#.....#......#..............................#.......#.#...#.#...#.....\r\n.................#........#...............#.........................................#......................#....#............#...#.\r\n.#...#.###...........#...#..##...............#.........#...##....................#...........#...............#....##...........#.#.\r\n..###...#.#.........##.................#.#.....#..##...........#....##........#...#...................##..##...#................#..\r\n...#.................#.....#...........#....#...##...#.......#............#.....#.#........#........#...#...##...#.##..............\r\n.......#....#.........#.#.....#.#.......#.....#....#...#.............#.....#.....#.##.....................#.###...........#........\r\n................#....#..#.......#.............#......#.......#.................#.#................#..........#.....##...#..#....#..\r\n........#...#...#.#......##......#.........#.......................#.........#...#.....................#..........#.#..#...#.......\r\n....#.......##......##....##.................#.....#.#.#....#...#...........#.......................#........#....#....#.....#...#.\r\n.#..##..##.........#......#.........#.......#....#....#...#.....#..#.....#.#............................#...#..................#.#.\r\n...#......#............##.....##.............##.................#..#....#.#...#....#......................##....#.....#........#...\r\n........#....#....#..........#.###....#................#..##......#..#...#..#......#..........##...............#..#.........#...#..\r\n.....#...#.##.....#....#.##.........#............##....#..#.#.....#.............#...................#..#............#..#..#.#....#.\r\n.....#..#.........##..#...........#....#............#.#...........#..............##.......#.#...........#..####.....##.#.##........\r\n...#.#.#.##.#.#..#.....#........###..#............#........##......##.#..........................####........##.#.....#......#.....\r\n.##.#.#...##..#........##....#........#............#...#...#......#....#....##..#...........#.#.........#.##...#...#...#...#.#.....\r\n......#.#..#.#........##.#....#.#...#.###..#...........#...................#.................#.#.#............##.#...#.#.........#.\r\n........#.#....#...#...#..........#.#..#..#...........#..#...#.....##......#.....................##..#........#.....#.#.....#....#.\r\n..#.......##....##............##...............................#......#.#..#.............#..........................#....#.........\r\n.......#....#................#...........#...##................#...#.#....#...............#....##.......................#.#.....#..\r\n..........#...........#..#..#.....#...........##...........#......#.#.#.#..........#..........#.....#......................###.....\r\n....#.......##...........#..........#..###.#.........................#....#..........#.#.........#......#............#..#.....#..#.\r\n...#.#...#...#.............#.......#...#.##..............................#........##.......##..#...#......................#........\r\n...........##.............#....##....#.#...#.#..............#..#..................#.......#......#.......#.................#..#....\r\n.#.##..#......#...#..#........#.......#.#.#....#...............#........................#..........#...............................\r\n........#...........#....#...#...##..#.#....###................#...#.................#..................#.......#....#........#..#.\r\n.........#.###.#....#..#..##..........#.#.......#............................#..##....#.....#....#....#.#...##......##.............\r\n..#.#..##.#........#..#.#...#........#...#...#.....................##...........#.....#...#.#.#...#.......#..#..#.........#..#..#..\r\n.....#..........####....##..##......#.............#...#...........#........#..........#.............###...#.#.#...#................\r\n..#.....#...#....#.#.........#....#..#.......##.....#.............#........#............#...###.........#...#......................\r\n.##..............#..#....#..#......#....##..#......#.###.#..................#...............#.#..#..#.##..........#............#.#.\r\n..#..#..#.....................#.#..............##...#.....#....................#..##...#.........#...........#..##.........#....#..\r\n....#...............#.......#.#....##....#..#..........................#.......#.##...........#.......#....#.#........#..#.........\r\n.....##.......#.................................#........#..................#..#.#......#....#..#....#...#.........................\r\n...................................................................................................................................";
            //InputData = "";   // Exemple donné pour debug
            #endregion

            InitInputData(InputData);

            Graph = new Graphe(Lines);

            if (this.Debug)
                DebugInit();
        }
        #endregion

        #region Initialisation
        /// <summary>
        /// Initialisation des données de travail pour une ligne.
        /// </summary>
        /// <param name="ligne">Données de la ligne d'entrée</param>
        private void InitialisationLigne(string ligne)
        {
            var Split = ligne.Split(' ').ToList();
        }
        #endregion

        #region Méthodes publiques
        public override long Partie1()
        {
            return ProcessPart1();
        }

        public override long Partie2()
        {
            return ProcessPart2();
        }
        #endregion

        #region Process
        private long ProcessPart1()
        {
            return Graph.GetNumberReachablePlots(64);
        }
        private long ProcessPart2()
        {
            return Graph.GetNumberReachablePlots(26501365);
        }
        #endregion

        #region Debug
        private void DebugInit()
        {
        }
        #endregion

        #region Classes de travail
        private class Field
        {
            public int X { get; private set; }
            public int Y { get; private set; }
            public long Id { get; private set; } = 0;
            public int? DistanceASource { get; set; } = null;
            public bool isReachable { get; private set; } = false;
            public char Type { get; private set; }
            public List<((long,long),Field)> Voisins { get; private set; } = new List<((long,long),Field)>();
            public Dictionary<long, List<(int, int)>> DejaVisites { get; set; } = new Dictionary<long, List<(int, int)>>();
            public List<long> Iterations { get; private set; } = new List<long>();
            public Field(int x, int y, char type, long id)
            {
                X = x;
                Y = y;
                Type = type;
                Id = id;
            }
            public void Init()
            {
                DistanceASource = null;
            }
            public List<((long, long), Field)> GetVoisins((long, long) Case)
            {
                List<((long, long), Field)> Res = new List<((long, long), Field)>();
                foreach(var V in Voisins)
                {
                    Res.Add(((Case.Item1 + V.Item1.Item1, Case.Item2 + V.Item1.Item2), V.Item2));
                }

                return Res;
            }
        }
        private class Graphe : Dictionary<(int, int), Field>
        {
            private Field? Source { get; set; } = null;
            public Graphe(List<string>inputData)
            {
                List<(int, int)> Operations = new List<(int, int)>()
                    {
                        (1,0),
                        (0,1),
                        (-1,0),
                        (0,-1)
                    };
                int NbLignes = inputData.Count;
                int NbCols = inputData[0].Length;
                long Id = 0;
                for (int y = 0; y < NbLignes; y++)
                {
                    for(int x = 0;  x < NbCols; x++)
                    {
                        Field f = new Field(x, y, inputData[y][x], ++Id);
                        switch (inputData[y][x])
                        {
                            case 'S':
                                this.Add((x, y), f);
                                Source = f;
                                break;
                            case '.':
                                this.Add((x, y), f);
                                break;

                        }
                    }
                }
                foreach(Field f in this.Select(d=>d.Value).ToList())
                {
                    foreach(var op in Operations)
                    {
                        if (this.TryGetValue((f.X + op.Item1, f.Y + op.Item2), out Field? voisin))
                        {
                            f.Voisins.Add(((0,0),voisin));
                        }
                    }
                    if (f.X == 0)
                    {
                        if (this.TryGetValue((NbCols - 1, f.Y), out Field? voisin))
                        {
                            f.Voisins.Add(((-1, 0), voisin));
                        }
                    }
                    if (f.Y == 0)
                    {
                        if (this.TryGetValue((f.X, NbLignes - 1), out Field? voisin))
                        {
                            f.Voisins.Add(((0, -1), voisin));
                        }
                    }
                    if (f.X == NbCols - 1)
                    {
                        if (this.TryGetValue((0, f.Y), out Field? voisin))
                        {
                            f.Voisins.Add(((1, 0), voisin));
                        }
                    }
                    if (f.Y == NbLignes - 1)
                    {
                        if (this.TryGetValue((f.X, 0), out Field? voisin))
                        {
                            f.Voisins.Add(((0, 1), voisin));
                        }
                    }
                }
            }

            public long GetNumberReachablePlots(int stepsRemaining)
            {
                if (Source != null)
                {
                    DateTime Debut = DateTime.Now;
                    List<((long, long), Field)> Traitement = new List<((long, long), Field)>() 
                    {
                        ((0,0),Source)
                     };
                    Dictionary<string, List<(int, (long, long))>> Memo = new Dictionary<string, List<(int, (long, long))>>();
                    Source.Iterations.Add(0);
                    for(int i = 0; i < stepsRemaining; i++)
                    {
                        List<((long, long), Field)> Next = Traitement.SelectMany(f => f.Item2.GetVoisins(f.Item1)).ToList();
                        Traitement.Clear();
                        var v1 = Next.Where(n => Math.Abs(n.Item1.Item1) + Math.Abs(n.Item1.Item2) <= 5).Distinct()
                                        .Select(n => new { Key = n.Item2.Id, Grid = (n.Item1.Item1, n.Item1.Item2), Index = Math.Abs(n.Item1.Item1) + Math.Abs(n.Item1.Item2) }).ToList();
                        var group = v1.GroupBy(g=>g.Grid).Select(g=>new { Key = g.Key, Index = string.Join("\n", g.OrderBy(g => g.Key).Select(g=> string.Join("|", g.Key) )) })
                                        .ToList();
                        var group2 = group.GroupBy(g=>g.Index).Select(g=> new { Key = g.Key, Grids = g.Select(g1=>g1.Key).ToList() }).ToList();
                        Traitement.AddRange(Next.Distinct());
                        foreach(var gr in group)
                        {
                            if (Memo.TryGetValue(gr.Index, out List<(int, (long, long))>? liste))
                            {
                                liste.Add((i, gr.Key));
                            }
                            else
                            {
                                Memo.Add(gr.Index, new List<(int, (long, long))>() { (i, gr.Key) });
                            }
                        }
                    }
                    Console.WriteLine();
                    return Traitement.Count;
                }
                return 0;
            }
        }
        #endregion
    }
}
